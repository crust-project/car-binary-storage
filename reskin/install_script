import os
import subprocess

version = "will.be.edited.post.install"
maintainer = [
    {"Name": "iamnotmega", "email": "iamnotmega@proton.me", "nick": "iamnotmega"}
]
trusted = "True"
description = A modern Linux desktop theming app for browsing, applying, and managing custom themes."
pacman_deps = ["nodejs", "npm", "webkit2gtk", "xdg-utils", "desktop-file-utils", "git"]
car_deps = []

def deps():
  print(":: This package uses pacman - the script will be recoded after our distro removes it completely")
  os.system("curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf | sh")
  os.system("sudo pacman -S nodejs npm webkit2gtk xdg-utils desktop-file-utils git --noconfirm")

def build():
  print(":: Downloading the binary")
  os.system("curl -L -o reskin https://github.com/iamnotmega/reskin/releases/latest/download/reskin")

def install():
  os.system("sudo mv reskin /usr/bin/reskin")

def postinst():
  print(":: Fetching latest version")
  # Run the command and capture output
  result = subprocess.run(
      "curl -s https://api.github.com/repos/iamnotmega/reskin/releases/latest | grep '\"tag_name\":' | sed -E 's/.*\"([^\"]+)\".*/\\1/'",
      shell=True,
      stdout=subprocess.PIPE,
      stderr=subprocess.PIPE,
      text=True
  )
  
  # Get the output and strip any extra whitespace/newlines
  version = result.stdout.strip()

  with open("/home/" + os.getlogin() + "/.config/repro.car", "r") as f:
    repro = f.read()
  with open("/home/" + os.getlogin() + "/.config/repro.car", "w") as f:
    f.write(repro.replace("reskin=will.be.edited.post.install", "reskin="+version))
  print(":: Edited version to: "+version)
  
  print(":: Documentation: https://reskinapp.github.io")
